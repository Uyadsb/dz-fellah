openapi: 3.0.3
info:
  title: DZ-Fellah Cart & Order API
  description: |
    Cart and Order management API for DZ-Fellah platform.
    
    ## Features
    - Shopping cart management
    - Order creation from cart
    - Multi-producer order system (parent orders + sub-orders)
    - Order status tracking
    - Producer order management
    - Quantity adjustments for weight-based products
    
    ## Order System
    The system uses a parent-child order structure:
    - **Parent Order**: Client's complete order view
    - **Sub-Orders**: One per producer, visible only to that producer
    
    ## Authentication
    All endpoints require JWT authentication:
    ```
    Authorization: Bearer <your_token>
    ```
  version: 2.0.0
  contact:
    name: DZ-Fellah Support
    email: support@dzfellah.dz

servers:
  - url: http://localhost:8000/api
    description: Development server
  - url: https://api.dzfellah.dz/api
    description: Production server

tags:
  - name: Cart
    description: Shopping cart operations (Client)
  - name: Orders
    description: Order management (Client view)
  - name: Producer Orders
    description: Order management (Producer view)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string

    ValidationError:
      type: object
      additionalProperties:
        type: array
        items:
          type: string

    # ========== CART SCHEMAS ==========
    
    ProductDetails:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        photo_url:
          type: string
          nullable: true
        sale_type:
          type: string
          enum: [unit, weight]
        product_type:
          type: string
          enum: [fresh, processed, other]
        current_price:
          type: number
          format: float
        stock:
          type: number
          format: float
        is_anti_gaspi:
          type: boolean
        producer:
          type: object
          properties:
            id:
              type: integer
            shop_name:
              type: string
            city:
              type: string
            wilaya:
              type: string

    CartItem:
      type: object
      properties:
        id:
          type: integer
        product_id:
          type: integer
        quantity:
          type: number
          format: decimal
        price_snapshot:
          type: number
          format: decimal
          description: Price at time of adding to cart
        subtotal:
          type: number
          format: float
        product_details:
          $ref: '#/components/schemas/ProductDetails'
        added_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ItemsByProducer:
      type: object
      properties:
        producer_id:
          type: integer
        shop_name:
          type: string
        city:
          type: string
        wilaya:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        subtotal:
          type: number
          format: float

    Cart:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        items_count:
          type: integer
        total:
          type: number
          format: float
        items_by_producer:
          type: array
          items:
            $ref: '#/components/schemas/ItemsByProducer'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AddToCartRequest:
      type: object
      required:
        - product_id
        - quantity
      properties:
        product_id:
          type: integer
        quantity:
          type: number
          format: decimal
          minimum: 0.01

    UpdateCartItemRequest:
      type: object
      required:
        - quantity
      properties:
        quantity:
          type: number
          format: decimal
          minimum: 0.01

    ValidationWarning:
      type: object
      properties:
        item_id:
          type: integer
        product_name:
          type: string
        old_price:
          type: number
          format: float
        new_price:
          type: number
          format: float
        difference:
          type: number
          format: float
        warning:
          type: string

    CartValidationResponse:
      type: object
      properties:
        valid:
          type: boolean
        errors:
          type: array
          items:
            type: object
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/ValidationWarning'
        message:
          type: string
        cart:
          $ref: '#/components/schemas/Cart'

    # ========== ORDER SCHEMAS ==========

    OrderItem:
      type: object
      properties:
        id:
          type: integer
        product_id:
          type: integer
        product_name:
          type: string
        quantity_ordered:
          type: number
          format: decimal
        quantity_actual:
          type: number
          format: decimal
          nullable: true
          description: Actual quantity after preparation (for weight-based products)
        unit_price:
          type: number
          format: decimal
        sale_type:
          type: string
          enum: [unit, weight]
        subtotal:
          type: number
          format: float
        price_adjustment:
          type: number
          format: float
          description: Difference if quantity_actual differs from quantity_ordered
        created_at:
          type: string
          format: date-time

    ProducerDetails:
      type: object
      properties:
        id:
          type: integer
        shop_name:
          type: string
        city:
          type: string
        wilaya:
          type: string
        phone:
          type: string
        address:
          type: string

    SubOrder:
      type: object
      properties:
        id:
          type: integer
        sub_order_number:
          type: string
          example: DZF-20231215-001-P1
        producer_id:
          type: integer
        producer_details:
          $ref: '#/components/schemas/ProducerDetails'
        status:
          type: string
          enum: [pending, confirmed, preparing, ready, completed, cancelled]
        subtotal:
          type: number
          format: decimal
        total:
          type: number
          format: float
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        producer_notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ClientDetails:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        phone:
          type: string

    Order:
      type: object
      properties:
        id:
          type: integer
        order_number:
          type: string
          example: DZF-20231215-001
        client_id:
          type: integer
        client_details:
          $ref: '#/components/schemas/ClientDetails'
        status:
          type: string
          enum: [pending, confirmed, preparing, ready, completed, cancelled]
        total_amount:
          type: number
          format: decimal
        delivery_method:
          type: string
          enum: [pickup_producer, pickup_point]
        delivery_address:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        sub_orders:
          type: array
          items:
            $ref: '#/components/schemas/SubOrder'
        sub_orders_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    OrderListItem:
      type: object
      properties:
        id:
          type: integer
        order_number:
          type: string
        status:
          type: string
          enum: [pending, confirmed, preparing, ready, completed, cancelled]
        total_amount:
          type: number
          format: decimal
        delivery_method:
          type: string
          enum: [pickup_producer, pickup_point]
        sub_orders_count:
          type: integer
        created_at:
          type: string
          format: date-time

    CreateOrderRequest:
      type: object
      required:
        - delivery_method
      properties:
        delivery_method:
          type: string
          enum: [pickup_producer, pickup_point]
          default: pickup_producer
        delivery_address:
          type: string
          maxLength: 500
          description: Required if delivery_method is pickup_point
        notes:
          type: string
          maxLength: 1000

    UpdateSubOrderStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [confirmed, preparing, ready, completed, cancelled]
        producer_notes:
          type: string
          maxLength: 1000

    AdjustQuantityRequest:
      type: object
      required:
        - quantity_actual
      properties:
        quantity_actual:
          type: number
          format: decimal
          minimum: 0.01
          description: Must be within ±30% of ordered quantity

paths:
  # ========== CART ENDPOINTS ==========

  /cart/my_cart/:
    get:
      tags:
        - Cart
      summary: Get my cart
      description: Retrieve the current user's shopping cart
      operationId: getMyCart
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Cart retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cart:
                    $ref: '#/components/schemas/Cart'
        '401':
          description: Unauthorized

  /cart/add_item/:
    post:
      tags:
        - Cart
      summary: Add item to cart
      description: Add a product to the shopping cart or update quantity if already exists
      operationId: addToCart
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddToCartRequest'
      responses:
        '201':
          description: Item added to cart
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cart:
                    $ref: '#/components/schemas/Cart'
                  item:
                    $ref: '#/components/schemas/CartItem'
        '200':
          description: Quantity updated (item already in cart)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cart:
                    $ref: '#/components/schemas/Cart'
                  item:
                    $ref: '#/components/schemas/CartItem'
        '400':
          description: Validation error or insufficient stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Only clients can buy products
        '404':
          description: Product not found

  /cart/update_item/{item_id}/:
    patch:
      tags:
        - Cart
      summary: Update cart item quantity
      description: Update the quantity of an item in the cart
      operationId: updateCartItem
      security:
        - BearerAuth: []
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCartItemRequest'
      responses:
        '200':
          description: Quantity updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cart:
                    $ref: '#/components/schemas/Cart'
                  item:
                    $ref: '#/components/schemas/CartItem'
        '400':
          description: Validation error or insufficient stock
        '401':
          description: Unauthorized
        '404':
          description: Item not found in cart

  /cart/remove_item/{item_id}/:
    delete:
      tags:
        - Cart
      summary: Remove item from cart
      description: Remove a specific item from the shopping cart
      operationId: removeCartItem
      security:
        - BearerAuth: []
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Item removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cart:
                    $ref: '#/components/schemas/Cart'
        '401':
          description: Unauthorized
        '404':
          description: Item not found in cart

  /cart/clear_cart/:
    delete:
      tags:
        - Cart
      summary: Clear cart
      description: Remove all items from the shopping cart
      operationId: clearCart
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Cart cleared successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cart:
                    $ref: '#/components/schemas/Cart'
        '401':
          description: Unauthorized

  /cart/validate_cart/:
    get:
      tags:
        - Cart
      summary: Validate cart
      description: Check if all products in cart are available and validate stock/prices
      operationId: validateCart
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Cart is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartValidationResponse'
        '400':
          description: Cart validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  errors:
                    type: array
                    items:
                      type: object
                  warnings:
                    type: array
                    items:
                      $ref: '#/components/schemas/ValidationWarning'
        '401':
          description: Unauthorized

  # ========== ORDER ENDPOINTS (CLIENT) ==========

  /orders/create_from_cart/:
    post:
      tags:
        - Orders
      summary: Create order from cart
      description: Create a new order from the current shopping cart
      operationId: createOrderFromCart
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  order:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Validation error or cart is empty
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Only clients can place orders

  /orders/my_orders/:
    get:
      tags:
        - Orders
      summary: Get my orders
      description: List all orders for the authenticated client
      operationId: getMyOrders
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderListItem'
        '401':
          description: Unauthorized

  /orders/{id}/:
    get:
      tags:
        - Orders
      summary: Get order detail
      description: Get detailed information about a specific order
      operationId: getOrderDetail
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  order:
                    $ref: '#/components/schemas/Order'
        '401':
          description: Unauthorized
        '404':
          description: Order not found

  /orders/{id}/cancel/:
    post:
      tags:
        - Orders
      summary: Cancel order
      description: Cancel an order (only if status is pending or confirmed)
      operationId: cancelOrder
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  order:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Order cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '404':
          description: Order not found

  # ========== PRODUCER ORDER ENDPOINTS ==========

  /producer-orders/my_orders/:
    get:
      tags:
        - Producer Orders
      summary: Get my sub-orders
      description: List all sub-orders for the authenticated producer
      operationId: getMyProducerOrders
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Sub-orders retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  sub_orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/SubOrder'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Only producers can access

  /producer-orders/{id}/:
    get:
      tags:
        - Producer Orders
      summary: Get sub-order detail
      description: Get detailed information about a specific sub-order
      operationId: getProducerOrderDetail
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Sub-order retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sub_order:
                    $ref: '#/components/schemas/SubOrder'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Only producers can access
        '404':
          description: Sub-order not found

  /producer-orders/{id}/update_status/:
    patch:
      tags:
        - Producer Orders
      summary: Update sub-order status
      description: Update the status of a sub-order (producer only)
      operationId: updateSubOrderStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSubOrderStatusRequest'
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  sub_order:
                    $ref: '#/components/schemas/SubOrder'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Only producers can access
        '404':
          description: Sub-order not found

  /producer-orders/{id}/adjust_item/{item_id}/:
    patch:
      tags:
        - Producer Orders
      summary: Adjust item quantity
      description: Adjust the actual quantity of a weight-based product (±30% of ordered quantity)
      operationId: adjustItemQuantity
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Sub-order ID
        - name: item_id
          in: path
          required: true
          schema:
            type: integer
          description: Order item ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdjustQuantityRequest'
      responses:
        '200':
          description: Quantity adjusted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  adjustment:
                    type: number
                    format: float
                    description: Price adjustment amount
                  sub_order:
                    $ref: '#/components/schemas/SubOrder'
        '400':
          description: Validation error or item is not weight-based
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Only producers can access
        '404':
          description: Sub-order or item not found